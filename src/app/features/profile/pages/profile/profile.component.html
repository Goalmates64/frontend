<section class="space-y-8">
  <header class="space-y-2">
    <p class="text-sm uppercase tracking-[0.2em] text-gm-primary font-semibold">
      Profil joueur
    </p>
    <h1 class="text-3xl font-bold">Tes informations personnelles</h1>
    <p class="text-gm-muted max-w-2xl">
      Mets à jour ton identité afin que tes coéquipiers sachent à qui ils parlent.
      Ces données restent privées et servent uniquement à améliorer votre expérience GoalMates.
    </p>
  </header>

  <div class="grid gap-6 lg:grid-cols-[2fr,1fr]">
    <form
      (ngSubmit)="onSubmit()"
      [formGroup]="form"
      class="bg-gm-surface border border-gm-border rounded-2xl p-8 shadow-lg flex flex-col gap-6"
    >
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="text-sm text-gm-muted mb-1 block" for="firstName">Prénom</label>
          <input
            class="w-full rounded-lg bg-gm-surface2 border border-gm-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gm-primary"
            formControlName="firstName"
            id="firstName"
            placeholder="Ex. Nabil"
            type="text"
          />
          <p *ngIf="f.firstName.errors?.['maxlength'] && f.firstName.touched" class="text-xs text-red-400 mt-1">
            Maximum 80 caractères.
          </p>
        </div>

        <div>
          <label class="text-sm text-gm-muted mb-1 block" for="lastName">Nom</label>
          <input
            class="w-full rounded-lg bg-gm-surface2 border border-gm-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gm-primary"
            formControlName="lastName"
            id="lastName"
            placeholder="Ex. Karim"
            type="text"
          />
          <p *ngIf="f.lastName.errors?.['maxlength'] && f.lastName.touched" class="text-xs text-red-400 mt-1">
            Maximum 80 caractères.
          </p>
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="text-sm text-gm-muted mb-1 block" for="dateOfBirth">Date de naissance</label>
          <input
            [attr.max]="today"
            class="w-full rounded-lg bg-gm-surface2 border border-gm-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gm-primary"
            formControlName="dateOfBirth"
            id="dateOfBirth"
            placeholder="1990-05-17"
            type="date"
          />
          <p *ngIf="f.dateOfBirth.errors?.['futureDate'] && f.dateOfBirth.touched" class="text-xs text-red-400 mt-1">
            Merci de choisir une date passée.
          </p>
          <p class="text-xs text-gm-muted mt-1">
            Nous utilisons cette info pour personnaliser les conseils forme & récupération. Pas de dates futures.
          </p>
        </div>

        <div>
          <label class="text-sm text-gm-muted mb-1 block" for="city">Ville</label>
          <input
            class="w-full rounded-lg bg-gm-surface2 border border-gm-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gm-primary"
            formControlName="city"
            id="city"
            placeholder="Casablanca"
            type="text"
          />
          <p *ngIf="f.city.errors?.['maxlength'] && f.city.touched" class="text-xs text-red-400 mt-1">
            Maximum 120 caractères.
          </p>
        </div>
      </div>

      <div>
        <label class="text-sm text-gm-muted mb-1 block" for="country">Pays</label>
        <select
          class="w-full rounded-lg bg-gm-surface2 border border-gm-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gm-primary"
          formControlName="country"
          id="country"
        >
          <option value="">Choisis ton pays</option>
          <option *ngIf="f.country.value && !hasCountryOption(f.country.value)" [value]="f.country.value">
            {{ f.country.value }}
          </option>
          <option *ngFor="let country of countries" [value]="country.name">
            {{ country.flag }} {{ country.name }}
          </option>
        </select>
        <p *ngIf="f.country.errors?.['maxlength'] && f.country.touched" class="text-xs text-red-400 mt-1">
          Maximum 120 caractères.
        </p>
      </div>

      <div *ngIf="apiError" class="text-xs text-red-400 bg-red-950/40 border border-red-900 rounded-lg px-3 py-2">
        {{ apiError }}
      </div>

      <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
        <button
          [disabled]="loading"
          class="inline-flex items-center justify-center rounded-lg bg-gm-primary text-gm-bg text-sm font-semibold px-4 py-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-500 transition"
          type="submit"
        >
          <span *ngIf="!loading">Sauvegarder mon profil</span>
          <span *ngIf="loading">Sauvegarde...</span>
        </button>
        <p class="text-xs text-gm-muted">
          Les modifications sont enregistrées instantanément sur tous tes appareils.
        </p>
      </div>
    </form>

    <aside class="bg-gm-surface2 border border-gm-border rounded-2xl p-6 space-y-6">
      <div class="space-y-4 rounded-2xl border border-gm-border bg-gm-surface p-4">
        <p class="text-sm text-gm-muted uppercase tracking-[0.3em]">Photo</p>
        <div class="flex items-center gap-4">
          <div class="relative h-24 w-24">
            <ng-container *ngIf="(user$ | async) as user; else avatarLoading">
              <img *ngIf="user.avatarUrl; else avatarPlaceholder"
                   [src]="user.avatarUrl"
                   alt="Photo de profil"
                   class="h-24 w-24 rounded-full object-cover border border-gm-border"/>
              <ng-template #avatarPlaceholder>
                <div
                  class="h-24 w-24 rounded-full border border-dashed border-gm-border bg-gm-surface2 flex items-center justify-center text-3xl font-semibold text-gm-muted">
                  {{ user.username ? (user.username | slice:0:1 | uppercase) : '?' }}
                </div>
              </ng-template>
            </ng-container>
            <ng-template #avatarLoading>
              <div
                class="h-24 w-24 rounded-full border border-dashed border-gm-border bg-gm-surface2 flex items-center justify-center text-3xl font-semibold text-gm-muted">
                ?
              </div>
            </ng-template>
            <div *ngIf="avatarUploading"
                 class="absolute inset-0 rounded-full bg-black/50 flex items-center justify-center text-xs">
              Upload...
            </div>
          </div>
          <div class="flex-1 space-y-2">
            <label
              class="inline-flex items-center gap-2 rounded-lg border border-gm-border px-4 py-2 text-sm font-semibold text-gm-primary hover:bg-gm-primary/10 cursor-pointer">
              <input (change)="onAvatarSelected($event)" accept="image/png,image/jpeg,image/webp" class="hidden"
                     type="file"/>
              Changer de photo
            </label>
            <p class="text-xs text-gm-muted">PNG, JPG ou WebP · 2 Mo max.</p>
            <p *ngIf="avatarError" class="text-xs text-red-400">{{ avatarError }}</p>
          </div>
        </div>
      </div>

      <div>
        <p class="text-sm text-gm-muted uppercase tracking-[0.3em]">Compte</p>
        <h2 class="text-xl font-semibold">Résumé rapide</h2>
      </div>

      <div class="space-y-4">
        <div>
          <p class="text-xs text-gm-muted">Email</p>
          <p class="font-medium text-sm">{{ (user$ | async)?.email }}</p>
        </div>
        <div>
          <p class="text-xs text-gm-muted">Pseudo GoalMates</p>
          <p class="font-medium text-sm">{{ (user$ | async)?.username }}</p>
        </div>
        <div>
          <p class="text-xs text-gm-muted">Localisation</p>
          <p class="font-medium text-sm">
            <ng-container *ngIf="(user$ | async) as user; else unknownLocation">
              {{ user.city || 'Ville inconnue' }} · {{ user.country || 'Pays inconnu' }}
            </ng-container>
          </p>
          <ng-template #unknownLocation>
            <span class="font-medium text-sm">Ville inconnue · Pays inconnu</span>
          </ng-template>
        </div>
      </div>


      <ng-container *ngIf="user$ | async as currentUser">
        <div class="rounded-2xl border border-gm-border bg-gm-surface p-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs text-gm-muted uppercase tracking-[0.3em]">2FA</p>
              <p class="text-sm font-semibold">
                Double authentification {{ currentUser.isTwoFactorEnabled ? 'activee' : 'desactivee' }}
              </p>
            </div>
            <span
              [ngClass]="currentUser.isTwoFactorEnabled
                ? 'bg-emerald-500/10 text-emerald-300 border border-emerald-500/40'
                : 'bg-gm-surface2 text-gm-muted border border-gm-border'"
              class="text-xs font-semibold px-3 py-1 rounded-full"
            >
              {{ currentUser.isTwoFactorEnabled ? 'Active' : 'Inactive' }}
            </span>
          </div>
          <p class="text-sm text-gm-muted">
            Ajoute une verification par code a 6 chiffres genere par ton application d'authentification.
          </p>
          <button
            *ngIf="!currentUser.isTwoFactorEnabled; else disableTwoFactorBtn"
            (click)="openEnableTwoFactor()"
            [disabled]="twoFactorSetupLoading || twoFactorActionLoading"
            class="w-full inline-flex items-center justify-center rounded-lg bg-gm-primary text-gm-bg text-sm font-semibold px-4 py-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-500 transition"
            type="button"
          >
            <span>Activer la double authentification</span>
          </button>
          <ng-template #disableTwoFactorBtn>
            <button
              (click)="openDisableTwoFactor()"
              [disabled]="twoFactorActionLoading"
              class="w-full inline-flex items-center justify-center rounded-lg bg-red-500/20 text-red-200 text-sm font-semibold px-4 py-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-red-500/40 transition"
              type="button"
            >
              <span>Desactiver la double authentification</span>
            </button>
          </ng-template>
          <p *ngIf="currentUser.isTwoFactorEnabled" class="text-xs text-gm-muted">
            Tu devras saisir ton code 2FA a chaque connexion.
          </p>
        </div>
      </ng-container>

      <div class="bg-gm-surface border border-dashed border-gm-border rounded-xl p-4">
        <p class="text-sm font-semibold mb-1">Conseil GoalMates</p>
        <p class="text-sm text-gm-muted">
          Un profil complet augmente les chances d'être invité aux matchs et facilite l'organisation.
        </p>
      </div>
    </aside>
  </div>

<div
  *ngIf="twoFactorModalOpen"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4"
>
  <div class="bg-gm-surface border border-gm-border rounded-2xl shadow-2xl w-full max-w-lg p-6 space-y-4 relative">
    <button
      (click)="closeTwoFactorModal()"
      class="absolute top-3 right-3 text-gm-muted hover:text-gm-primary text-sm"
      type="button"
    >
      Fermer
    </button>
    <h3 class="text-xl font-semibold">
      {{ twoFactorMode === 'enable' ? 'Activer la double authentification' : 'Desactiver la double authentification' }}
    </h3>
    <p class="text-sm text-gm-muted" *ngIf="twoFactorMode === 'enable'">
      Scanne le QR code avec ton application (Google Authenticator, 1Password, etc.) puis saisis le code a 6 chiffres.
    </p>
    <p class="text-sm text-gm-muted" *ngIf="twoFactorMode === 'disable'">
      Confirme avec ton code actuel pour desactiver la double authentification.
    </p>

    <div *ngIf="twoFactorSetupLoading" class="text-sm text-gm-muted">
      Generation du QR code...
    </div>

    <ng-container *ngIf="!twoFactorSetupLoading">
      <div *ngIf="twoFactorMode === 'enable' && twoFactorSetup" class="space-y-3 text-center">
        <img
          *ngIf="twoFactorSetup.qrCodeDataUrl"
          [src]="twoFactorSetup.qrCodeDataUrl"
          alt="QR 2FA"
          class="mx-auto h-40 w-40 border border-gm-border rounded-xl bg-gm-surface2 p-3"
        />
        <p class="text-xs text-gm-muted">Code secret</p>
        <p class="font-mono text-sm bg-gm-surface2 border border-dashed border-gm-border rounded-lg px-3 py-2 inline-block">
          {{ twoFactorSetup.secret }}
        </p>
      </div>

      <form (ngSubmit)="submitTwoFactorCode()" class="space-y-3">
        <div>
          <label class="block text-sm mb-1" for="twoFactorModalCode">Code a 6 chiffres</label>
          <input
            [formControl]="twoFactorCodeControl"
            class="w-full rounded-lg bg-gm-surface2 border border-gm-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gm-primary"
            id="twoFactorModalCode"
            inputmode="numeric"
            maxlength="6"
            placeholder="123456"
            type="text"
          />
          <p
            *ngIf="twoFactorCodeControl.touched && twoFactorCodeControl.invalid"
            class="text-xs text-red-400 mt-1"
          >
            Code a 6 chiffres requis.
          </p>
        </div>

        <div *ngIf="twoFactorError" class="text-xs text-red-400 bg-red-950/40 border border-red-900 rounded-lg px-3 py-2">
          {{ twoFactorError }}
        </div>

        <div class="flex flex-col sm:flex-row gap-3">
          <button
            class="flex-1 rounded-lg border border-gm-border px-4 py-2 text-sm font-semibold hover:bg-gm-surface2 transition"
            type="button"
            (click)="closeTwoFactorModal()"
          >
            Annuler
          </button>
          <button
            [disabled]="twoFactorActionLoading"
            class="flex-1 rounded-lg bg-gm-primary text-gm-bg text-sm font-semibold px-4 py-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-500 transition"
            type="submit"
          >
            <span *ngIf="!twoFactorActionLoading">Continuer</span>
            <span *ngIf="twoFactorActionLoading">Validation...</span>
          </button>
        </div>
      </form>
    </ng-container>
  </div>
</div>

</section>
